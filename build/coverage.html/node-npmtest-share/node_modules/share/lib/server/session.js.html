<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for node-npmtest-share/node_modules/share/lib/server/session.js</title>
    <meta charset="utf-8">
    <style>
        body, html {
            margin:0; padding: 0;
        }
        body {
            font-family: Arial, Helvetica;
            font-size: 10pt;
        }
        div.header, div.footer {
            background: #eee;
            padding: 1em;
        }
        div.header {
            height: 160px;
            padding: 0 1em 0 1em;
            z-index: 100;
            position: fixed;
            top: 0;
            border-bottom: 1px solid #666;
            width: 100%;
        }
        div.footer {
            border-top: 1px solid #666;
        }
        div.body {
            margin-top: 170px;
        }
        div.meta {
            font-size: 90%;
            text-align: center;
        }
        h1, h2, h3 {
            font-weight: normal;
        }
        h1 {
            font-size: 12pt;
        }
        h2 {
            font-size: 10pt;
        }
        pre {
            font-family: Menlo, Monaco, Consolas, Courier New, monospace;
            margin: 0;
            padding: 0;
            font-size: 14px;
            tab-size: 2;
        }

        div.path { font-size: 110%; }
        div.path a:link, div.path a:visited { color: #000; }
        table.coverage { border-collapse: collapse; margin:0; padding: 0 }

        table.coverage td {
            margin: 0;
            padding: 0;
            color: #111;
            vertical-align: top;
        }
        table.coverage td.line-count {
            width: 50px;
            text-align: right;
            padding-right: 5px;
        }
        table.coverage td.line-coverage {
            color: #777 !important;
            text-align: right;
            border-left: 1px solid #666;
            border-right: 1px solid #666;
        }

        table.coverage td.text {
        }

        table.coverage td span.cline-any {
            display: inline-block;
            padding: 0 5px;
            width: 40px;
        }
        table.coverage td span.cline-neutral {
            background: #eee;
        }
        table.coverage td span.cline-yes {
            background: #b5d592;
            color: #999;
        }
        table.coverage td span.cline-no {
            background: #fc8c84;
        }

        .cstat-yes { color: #111; }
        .cstat-no { background: #fc8c84; color: #111; }
        .fstat-no { background: #ffc520; color: #111 !important; }
        .cbranch-no { background:  yellow !important; color: #111; }

        .cstat-skip { background: #ddd; color: #111; }
        .fstat-skip { background: #ddd; color: #111 !important; }
        .cbranch-skip { background: #ddd !important; color: #111; }

        .missing-if-branch {
            display: inline-block;
            margin-right: 10px;
            position: relative;
            padding: 0 4px;
            background: black;
            color: yellow;
        }

        .skip-if-branch {
            display: none;
            margin-right: 10px;
            position: relative;
            padding: 0 4px;
            background: #ccc;
            color: white;
        }

        .missing-if-branch .typ, .skip-if-branch .typ {
            color: inherit !important;
        }

        .entity, .metric { font-weight: bold; }
        .metric { display: inline-block; border: 1px solid #333; padding: 0.3em; background: white; }
        .metric small { font-size: 80%; font-weight: normal; color: #666; }

        div.coverage-summary table { border-collapse: collapse; margin: 3em; font-size: 110%; }
        div.coverage-summary td, div.coverage-summary table  th { margin: 0; padding: 0.25em 1em; border-top: 1px solid #666; border-bottom: 1px solid #666; }
        div.coverage-summary th { text-align: left; border: 1px solid #666; background: #eee; font-weight: normal; }
        div.coverage-summary th.file { border-right: none !important; }
        div.coverage-summary th.pic { border-left: none !important; text-align: right; }
        div.coverage-summary th.pct { border-right: none !important; }
        div.coverage-summary th.abs { border-left: none !important; text-align: right; }
        div.coverage-summary td.pct { text-align: right; border-left: 1px solid #666; }
        div.coverage-summary td.abs { text-align: right; font-size: 90%; color: #444; border-right: 1px solid #666; }
        div.coverage-summary td.file { text-align: right; border-left: 1px solid #666; white-space: nowrap;  }
        div.coverage-summary td.pic { min-width: 120px !important;  }
        div.coverage-summary a:link { color: #000; }
        div.coverage-summary a:visited { color: #333; }
        div.coverage-summary tfoot td { border-top: 1px solid #666; }

        div.coverage-summary .yui3-datatable-sort-indicator, div.coverage-summary .dummy-sort-indicator {
            height: 10px;
            width: 7px;
            display: inline-block;
            margin-left: 0.5em;
        }
        div.coverage-summary .yui3-datatable-sort-indicator {
            background: no-repeat scroll 0 0 transparent;
        }
        div.coverage-summary .yui3-datatable-sorted .yui3-datatable-sort-indicator {
            background-position: 0 -20px;
        }
        div.coverage-summary .yui3-datatable-sorted-desc .yui3-datatable-sort-indicator {
            background-position: 0 -10px;
        }

        .high { background: #b5d592 !important; }
        .medium { background: #ffe87c !important; }
        .low { background: #fc8c84 !important; }

        span.cover-fill, span.cover-empty {
            display:inline-block;
            border:1px solid #444;
            background: white;
            height: 12px;
        }
        span.cover-fill {
            background: #ccc;
            border-right: 1px solid #444;
        }
        span.cover-empty {
            background: white;
            border-left: none;
        }
        span.cover-full {
            border-right: none !important;
        }
        pre.prettyprint {
            border: none !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        .com { color: #999 !important; }
        .ignore-none { color: #999; font-weight: normal; }

    </style>
</head>
<body>
<div class="header low">
    <h1 style="font-weight: bold;">
        <a href="https://github.com/npmtest/node-npmtest-share">npmtest-share (v0.0.1)</a>
    </h1>
    <h1>Code coverage report for <span class="entity">node-npmtest-share/node_modules/share/lib/server/session.js</span></h1>
    <h2>
        
        Statements: <span class="metric">6.99% <small>(23 / 329)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Branches: <span class="metric">0% <small>(0 / 182)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Functions: <span class="metric">0% <small>(0 / 41)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Lines: <span class="metric">7.69% <small>(23 / 299)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../../../../../index.html">All files</a> &#187; <a href="index.html">node-npmtest-share/node_modules/share/lib/server/</a> &#187; session.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551
552
553
554
555
556
557
558
559
560
561
562
563
564
565
566
567
568
569
570
571
572
573
574
575
576
577
578
579
580
581
582
583
584
585
586
587
588
589
590
591
592
593
594
595
596
597
598
599
600
601
602
603
604
605
606
607
608
609
610
611
612
613
614
615
616
617
618
619
620
621
622
623
624
625
626
627
628
629
630
631
632
633
634
635
636
637
638
639
640
641
642
643
644
645
646
647
648
649
650
651
652
653
654
655
656
657
658
659
660
661
662
663
664
665
666
667
668
669
670
671
672
673
674
675
676
677
678
679
680
681
682
683
684
685
686
687
688
689
690
691
692
693
694
695
696
697
698
699
700
701
702
703
704
705
706
707
708
709
710
711
712
713
714
715
716
717</td><td class="line-coverage"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// This implements the network API for ShareJS.
//
// The wire protocol is speccced out here:
// https://github.com/josephg/ShareJS/wiki/Wire-Protocol
//
// When a client connects the server first authenticates it and sends:
//
// S: {id:&lt;agent session id&gt;}
//
// After that, the client can open documents:
//
// C: {c:'users', d:'fred', sub:true, snapshot:null, create:true, type:'text'}
// S: {c:'users', d:'fred', sub:true, snapshot:{snapshot:'hi there', v:5, meta:{}}, create:false}
//
// ...
//
// The client can send open requests as soon as the socket has opened - it doesn't need to
// wait for its id.
//
// The wire protocol is documented here:
// https://github.com/josephg/ShareJS/wiki/Wire-Protocol
&nbsp;
var hat = require('hat');
var assert = require('assert');
&nbsp;
// stream is a nodejs 0.10 stream object.
/**
 * @param {ShareInstance} instance
 * @param {Duplex} stream
 * @param {Http.Request} req
 */
module.exports = Session;
&nbsp;
/**
 * Session deserializes the wire protocol messages received from the stream and
 * calls the corresponding functions on its UserAgent. It uses the return values
 * to send responses back. Session also handles piping the operation streams
 * provided by a UserAgent.
 *
 * @param {ShareInstance} instance
 * @param {Duplex} stream connection to a client
 */
<span class="fstat-no" title="function not covered" >function Session(instance, stream) {</span>
  // The stream passed in should be a nodejs 0.10-style stream.
<span class="cstat-no" title="statement not covered" >  this.stream = stream;</span>
&nbsp;
  // This is the user agent through which a connecting client acts.  The agent
  // is responsible for making sure client requests are properly authorized,
  // and metadata is kept up to date.
<span class="cstat-no" title="statement not covered" >  this.agent = instance.createAgent(stream);</span>
<span class="cstat-no" title="statement not covered" >  this.agent.session = this;</span>
&nbsp;
  // We need to track which documents are subscribed by the client. This is a
  // map of collection name -&gt; {doc name: stream || true || false}
<span class="cstat-no" title="statement not covered" >  this.collections = {};</span>
&nbsp;
  // Map from query ID -&gt; emitter.
<span class="cstat-no" title="statement not covered" >  this.queries = {};</span>
&nbsp;
  // Subscriptions care about the stream being destroyed. We end up with a
  // listener per subscribed document for the client, which can be a lot.
<span class="cstat-no" title="statement not covered" >  stream.setMaxListeners(0);</span>
&nbsp;
  // We need to track this manually to make sure we don't reply to messages
  // after the stream was closed. There's no built-in way to ask a stream
  // whether its actually still open.
<span class="cstat-no" title="statement not covered" >  this.closed = false;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  stream.once('end', this._cleanup.bind(this));</span>
&nbsp;
  // Initialize the remote client by sending it its session Id.
<span class="cstat-no" title="statement not covered" >  this._send({a:'init', protocol:0, id:this.agent.sessionId});</span>
}
&nbsp;
Session.prototype._cleanup = <span class="fstat-no" title="function not covered" >function() {</span>
<span class="cstat-no" title="statement not covered" >  if (this.closed) <span class="cstat-no" title="statement not covered" >return</span></span>
<span class="cstat-no" title="statement not covered" >  this.closed = true;</span>
&nbsp;
  // Remove the pump listener
<span class="cstat-no" title="statement not covered" >  this.stream.removeAllListeners('readable');</span>
&nbsp;
  // Clean up all the subscriptions.
<span class="cstat-no" title="statement not covered" >  for (var c in this.collections) {</span>
<span class="cstat-no" title="statement not covered" >    for (var docName in this.collections[c]) {</span>
<span class="cstat-no" title="statement not covered" >      var value = this.collections[c][docName];</span>
      // Value can be true, false or a stream. true means we're in the
      // process of subscribing the client.
<span class="cstat-no" title="statement not covered" >      if (typeof value === 'object') {</span>
<span class="cstat-no" title="statement not covered" >        destroyStream(value);</span>
      }
<span class="cstat-no" title="statement not covered" >      this.collections[c][docName] = false; </span>// cancel the subscribe
    }
  }
&nbsp;
<span class="cstat-no" title="statement not covered" >  for (var id in this.queries) {</span>
<span class="cstat-no" title="statement not covered" >    var emitter = this.queries[id];</span>
<span class="cstat-no" title="statement not covered" >    emitter.destroy();</span>
<span class="cstat-no" title="statement not covered" >    delete this.queries[id];</span>
  }
};
&nbsp;
// Close the session with the client.
Session.prototype.close = <span class="fstat-no" title="function not covered" >function(err) {</span>
<span class="cstat-no" title="statement not covered" >  if (err) {</span>
<span class="cstat-no" title="statement not covered" >    console.warn('Session closed due to error', err);</span>
<span class="cstat-no" title="statement not covered" >    this.stream.emit('error', err);</span>
  }
<span class="cstat-no" title="statement not covered" >  if (this.closed) <span class="cstat-no" title="statement not covered" >return;</span></span>
  // This will emit 'end', which will call _cleanup
<span class="cstat-no" title="statement not covered" >  this.stream.end();</span>
};
&nbsp;
// Mark a document as subscribed or unsubscribed. The value is stored
// associated with the subscription. It is set to true (subscribing), false
// (unsubscribed) or the actual operation stream.
Session.prototype._setSubscribed = <span class="fstat-no" title="function not covered" >function(collection, docName, value) {</span>
<span class="cstat-no" title="statement not covered" >  var docs = this.collections[collection] || (this.collections[collection] = {});</span>
  // Check to see if already subscribed
<span class="cstat-no" title="statement not covered" >  var previous = docs[docName];</span>
<span class="cstat-no" title="statement not covered" >  if (typeof value === 'object') {</span>
<span class="cstat-no" title="statement not covered" >    if (previous !== true) {</span>
      // The document has been unsubscribed or replaced with another stream
      // already. Either way, we destroy the new stream, since the existing
      // stream should have been subscribed the whole time. Possible I might be
      // missing some race condition and we might miss a message (nateps)
<span class="cstat-no" title="statement not covered" >      destroyStream(value);</span>
<span class="cstat-no" title="statement not covered" >      return previous;</span>
    }
  } else <span class="cstat-no" title="statement not covered" >if (value === true) {</span>
    // Reject replacing subscribed stream or subscribing state with
    // a new subscribing state
<span class="cstat-no" title="statement not covered" >    if (previous) {</span>
      // Return existing stream or subscribing state on failure
<span class="cstat-no" title="statement not covered" >      return previous;</span>
    }
  } else {
    // Unsubscribe
<span class="cstat-no" title="statement not covered" >    if (typeof previous === 'object') {</span>
<span class="cstat-no" title="statement not covered" >      destroyStream(previous);</span>
    }
  }
  // Set to new value
<span class="cstat-no" title="statement not covered" >  docs[docName] = value;</span>
  // Returns nothing on success
};
&nbsp;
// Check whether or not the document is subscribed by this session.
Session.prototype._isSubscribed = <span class="fstat-no" title="function not covered" >function(c, docName) {</span>
<span class="cstat-no" title="statement not covered" >  return this.collections[c] &amp;&amp; this.collections[c][docName];</span>
};
&nbsp;
/**
 * Passes operation data received on opstream to the session stream via
 * _sendOp()
 */
Session.prototype._subscribeToStream = <span class="fstat-no" title="function not covered" >function(collection, docName, opstream) {</span>
<span class="cstat-no" title="statement not covered" >  var previous = this._setSubscribed(collection, docName, opstream);</span>
  // Our set was rejected and our stream was destroyed, so just return
<span class="cstat-no" title="statement not covered" >  if (previous) <span class="cstat-no" title="statement not covered" >return;</span></span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  var self = this;</span>
  // This should use the new streams API instead of the old one.
<span class="cstat-no" title="statement not covered" >  opstream.on('data', onData);</span>
<span class="fstat-no" title="function not covered" >  function onData(data) {</span>
<span class="cstat-no" title="statement not covered" >    self._sendOp(collection, docName, data);</span>
  };
<span class="cstat-no" title="statement not covered" >  opstream.once('end', <span class="fstat-no" title="function not covered" >function() {</span></span>
    // Livedb has closed the op stream. What do we do here? Normally this
    // shouldn't happen unless we're cleaning up, so I'll assume thats whats
    // happening now.
<span class="cstat-no" title="statement not covered" >    self._setSubscribed(collection, docName, false);</span>
<span class="cstat-no" title="statement not covered" >    opstream.removeListener('data', onData);</span>
  });
};
&nbsp;
// Subscribe to the named document at the specified version. The version is
// optional.
Session.prototype._subscribe = <span class="fstat-no" title="function not covered" >function(collection, docName, v, callback) {</span>
<span class="cstat-no" title="statement not covered" >  var self = this;</span>
<span class="cstat-no" title="statement not covered" >  this._setSubscribed(collection, docName, true);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  if (v != null) {</span>
    // This logic is mirrored in _processQueryResults below. If you change
    // how it works, update that function too.
    // Yes, I know I'm a bad person.
<span class="cstat-no" title="statement not covered" >    this.agent.subscribe(collection, docName, v, <span class="fstat-no" title="function not covered" >function(err, opstream) {</span></span>
<span class="cstat-no" title="statement not covered" >      if (err) {</span>
<span class="cstat-no" title="statement not covered" >        self._setSubscribed(collection, docName, false);</span>
<span class="cstat-no" title="statement not covered" >        return callback(err);</span>
      }
<span class="cstat-no" title="statement not covered" >      self._subscribeToStream(collection, docName, opstream);</span>
<span class="cstat-no" title="statement not covered" >      callback();</span>
    });
  } else {
    // Rewrite me to not use fetchAndSubscribe.
<span class="cstat-no" title="statement not covered" >    this.agent.fetchAndSubscribe(collection, docName, <span class="fstat-no" title="function not covered" >function(err, data, opstream) {</span></span>
<span class="cstat-no" title="statement not covered" >      if (err) {</span>
<span class="cstat-no" title="statement not covered" >        self._setSubscribed(collection, docName, false);</span>
<span class="cstat-no" title="statement not covered" >        return callback(err);</span>
      }
<span class="cstat-no" title="statement not covered" >      self._subscribeToStream(collection, docName, opstream);</span>
<span class="cstat-no" title="statement not covered" >      callback(null, data);</span>
    });
  }
};
&nbsp;
// Bulk subscribe. The message is:
// {a:'bs', d:{users:{fred:100, george:5, carl:null}, cname:{...}}}
Session.prototype.bulkSubscribe = <span class="fstat-no" title="function not covered" >function(request, callback) {</span>
  // For each document there are three cases:
  // - The document is already subscribed. Do nothing
  // - The client doesn't have a snapshot (v=null). We need to do a fetch then ...
  // - The client has a snapshot already (most common case) and is resubscribing. We need to subscribe.
&nbsp;
  // This is a bulk fetch request for all documents that the client doesn't have data for.
<span class="cstat-no" title="statement not covered" >  var needFetch = {};</span>
&nbsp;
  // The eventual response.
<span class="cstat-no" title="statement not covered" >  var response = {};</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  for (var cName in request) {</span>
<span class="cstat-no" title="statement not covered" >    var docs = request[cName];</span>
    // Every doc in the request will get a response.
<span class="cstat-no" title="statement not covered" >    response[cName] = {};</span>
<span class="cstat-no" title="statement not covered" >    for (var docName in docs) {</span>
      // Mark the subscription.
<span class="cstat-no" title="statement not covered" >      this._setSubscribed(cName, docName, true);</span>
&nbsp;
      // Populate the bulk fetch request.
<span class="cstat-no" title="statement not covered" >      if (docs[docName] == null) {</span>
<span class="cstat-no" title="statement not covered" >        needFetch[cName] = needFetch[cName] || [];</span>
<span class="cstat-no" title="statement not covered" >        needFetch[cName].push(docName);</span>
      }
    }
  }
&nbsp;
<span class="cstat-no" title="statement not covered" >  var self = this;</span>
<span class="cstat-no" title="statement not covered" >  var agent = this.agent;</span>
&nbsp;
  // Next we do a bulkFetch on all the items that need a fetchin'. If no
  // documents need a fetch, this returns into the callback immediately.
<span class="cstat-no" title="statement not covered" >  agent.bulkFetch(needFetch, <span class="fstat-no" title="function not covered" >function(err, snapshots) {</span></span>
<span class="cstat-no" title="statement not covered" >    if (err) {</span>
      // For now, just abort the whole bundle on error. We could be more
      // neuanced about this, but I'll wait for a use case.
<span class="cstat-no" title="statement not covered" >      self._cancelBulk(request);</span>
<span class="cstat-no" title="statement not covered" >      return callback(err);</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    for (var cName in snapshots) {</span>
<span class="cstat-no" title="statement not covered" >      for (var docName in snapshots[cName]) {</span>
<span class="cstat-no" title="statement not covered" >        var snapshot = snapshots[cName][docName];</span>
        // Set the version that we'll subscribe to
<span class="cstat-no" title="statement not covered" >        request[cName][docName] = snapshot.v;</span>
        // Set the snapshot in the response
<span class="cstat-no" title="statement not covered" >        response[cName][docName] = snapshot;</span>
      }
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    agent.bulkSubscribe(request, <span class="fstat-no" title="function not covered" >function(err, streams) {</span></span>
<span class="cstat-no" title="statement not covered" >      if (err) {</span>
<span class="cstat-no" title="statement not covered" >        self._cancelBulk(request);</span>
<span class="cstat-no" title="statement not covered" >        return callback(err);</span>
      }
&nbsp;
<span class="cstat-no" title="statement not covered" >      for (var cName in streams) {</span>
<span class="cstat-no" title="statement not covered" >        for (var docName in streams[cName]) {</span>
          // Just give a thumbs up for the subscription.
<span class="cstat-no" title="statement not covered" >          response[cName][docName] = response[cName][docName] || true;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >          var v = request[cName][docName].v;</span>
<span class="cstat-no" title="statement not covered" >          self._subscribeToStream(cName, docName, streams[cName][docName]);</span>
        }
      }
&nbsp;
<span class="cstat-no" title="statement not covered" >      callback(null, response);</span>
    });
  });
};
&nbsp;
Session.prototype._cancelBulk = <span class="fstat-no" title="function not covered" >function(request) {</span>
  // Cancel the subscribed state on the documents.
<span class="cstat-no" title="statement not covered" >  for (var cName in request) {</span>
<span class="cstat-no" title="statement not covered" >    var docs = request[cName];</span>
<span class="cstat-no" title="statement not covered" >    for (var docName in docs) {</span>
<span class="cstat-no" title="statement not covered" >      this._setSubscribed(cName, docName, false);</span>
    }
  }
};
&nbsp;
// Send a message to the remote client.
Session.prototype._send = <span class="fstat-no" title="function not covered" >function(msg) {</span>
  // Quietly drop replies if the stream was closed
<span class="cstat-no" title="statement not covered" >  if (this.closed) <span class="cstat-no" title="statement not covered" >return;</span></span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  this.stream.write(msg);</span>
};
&nbsp;
Session.prototype._sendOp = <span class="fstat-no" title="function not covered" >function(collection, docName, data) {</span>
<span class="cstat-no" title="statement not covered" >  var msg = {</span>
    a: 'op',
    c: collection,
    d: docName,
    v: data.v,
    src: data.src,
    seq: data.seq
  };
&nbsp;
  // In theory, we only need to send the operation data if data.src !==
  // this.agent.sessionId. However, this doesn't work with projections because
  // the client needs to see their own operations in the projected collection.
  //
  // I'd like to reinstate this optimization, but I can't think of a good way to
  // do it while making projections work. For now, you get your own operations
  // back.
<span class="cstat-no" title="statement not covered" >  if (data.op) <span class="cstat-no" title="statement not covered" >msg.op = data.op;</span></span>
<span class="cstat-no" title="statement not covered" >  if (data.create) <span class="cstat-no" title="statement not covered" >msg.create = data.create;</span></span>
<span class="cstat-no" title="statement not covered" >  if (data.del) <span class="cstat-no" title="statement not covered" >msg.del = true;</span></span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  this._send(msg);</span>
};
&nbsp;
Session.prototype._reply = <span class="fstat-no" title="function not covered" >function(req, err, msg) {</span>
<span class="cstat-no" title="statement not covered" >  if (err) {</span>
<span class="cstat-no" title="statement not covered" >    msg = {a:req.a, error:err};</span>
  } else {
<span class="cstat-no" title="statement not covered" >    if (!msg.a) <span class="cstat-no" title="statement not covered" >msg.a = req.a;</span></span>
  }
&nbsp;
<span class="cstat-no" title="statement not covered" >  if (req.c) <span class="cstat-no" title="statement not covered" >msg.c = req.c; </span></span>// collection
<span class="cstat-no" title="statement not covered" >  if (req.d) <span class="cstat-no" title="statement not covered" >msg.d = req.d; </span></span>// docName
<span class="cstat-no" title="statement not covered" >  if (req.id) <span class="cstat-no" title="statement not covered" >msg.id = req.id;</span></span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  this._send(msg);</span>
};
&nbsp;
// start processing events from the stream. This calls itself recursively.
// Use .close() to drain the pump.
Session.prototype.pump = <span class="fstat-no" title="function not covered" >function() {</span>
<span class="cstat-no" title="statement not covered" >  if (this.closed) <span class="cstat-no" title="statement not covered" >return;</span></span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  var req = this.stream.read();</span>
<span class="cstat-no" title="statement not covered" >  var self = this;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  if (req != null) {</span>
<span class="cstat-no" title="statement not covered" >    if (typeof req === 'string') {</span>
<span class="cstat-no" title="statement not covered" >      try {</span>
<span class="cstat-no" title="statement not covered" >        req = JSON.parse(req);</span>
      } catch(e) {
<span class="cstat-no" title="statement not covered" >        console.warn('Client sent invalid JSON', e.stack);</span>
<span class="cstat-no" title="statement not covered" >        self.close(e);</span>
      }
    }
<span class="cstat-no" title="statement not covered" >    this._handleMessage(req, <span class="fstat-no" title="function not covered" >function(err, msg) {</span></span>
<span class="cstat-no" title="statement not covered" >      if (err || msg) <span class="cstat-no" title="statement not covered" >self._reply(req, err, msg);</span></span>
&nbsp;
      // This is in a process.nextTick to avoid stack smashing attacks (since
      // sometimes this callback function is called synchronously).
<span class="cstat-no" title="statement not covered" >      process.nextTick(<span class="fstat-no" title="function not covered" >function() {</span></span>
<span class="cstat-no" title="statement not covered" >        self.pump();</span>
      });
    });
  } else {
    // Retry when there's a message waiting for us.
<span class="cstat-no" title="statement not covered" >    this.stream.once('readable', this.pump.bind(this));</span>
  }
};
&nbsp;
// Check a request to see if its valid. Returns an error if there's a problem.
Session.prototype._checkRequest = <span class="fstat-no" title="function not covered" >function(req) {</span>
<span class="cstat-no" title="statement not covered" >  if (req.a === 'qsub' || req.a === 'qfetch' || req.a === 'qunsub') {</span>
    // Query messages need an ID property.
<span class="cstat-no" title="statement not covered" >    if (typeof req.id !== 'number') <span class="cstat-no" title="statement not covered" >return 'Missing query ID';</span></span>
  } else <span class="cstat-no" title="statement not covered" >if (req.a === 'op' || req.a === 'sub' || req.a === 'unsub' || req.a === 'fetch') {</span>
    // Doc-based request.
<span class="cstat-no" title="statement not covered" >    if (req.c != null &amp;&amp; typeof req.c !== 'string') <span class="cstat-no" title="statement not covered" >return 'Invalid collection';</span></span>
<span class="cstat-no" title="statement not covered" >    if (req.d != null &amp;&amp; typeof req.d !== 'string') <span class="cstat-no" title="statement not covered" >return 'Invalid docName';</span></span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (req.a === 'op') {</span>
<span class="cstat-no" title="statement not covered" >      if (req.v != null &amp;&amp; (typeof req.v !== 'number' || req.v &lt; 0)) <span class="cstat-no" title="statement not covered" >return 'Invalid version';</span></span>
    }
  } else <span class="cstat-no" title="statement not covered" >if (req.a === 'bs') {</span>
    // Bulk subscribe
<span class="cstat-no" title="statement not covered" >    if (typeof req.s !== 'object') <span class="cstat-no" title="statement not covered" >return 'Invalid bulk subscribe data';</span></span>
  } else {
<span class="cstat-no" title="statement not covered" >    return 'Invalid action';</span>
  }
};
&nbsp;
// This function takes in results from livedb and returns a results set to be
// sent to the sharejs client.
//
// Because I'm a moron, in livedb the snapshot data objects in
// results look like {c:, docName:, v:, type:, data:}. ShareJS expects them to have
// {c:, docName:, v:, type:, snapshot:}. So I have to rewrite them.
Session.prototype._processQueryResults = <span class="fstat-no" title="function not covered" >function(collection, results, qopts) {</span>
<span class="cstat-no" title="statement not covered" >  var self = this;</span>
<span class="cstat-no" title="statement not covered" >  var messages = [];</span>
&nbsp;
  // Types are only put in the result set for the first result and every time the type changes.
<span class="cstat-no" title="statement not covered" >  var lastType = null;</span>
<span class="cstat-no" title="statement not covered" >  results.forEach(<span class="fstat-no" title="function not covered" >function(r) {</span></span>
<span class="cstat-no" title="statement not covered" >    var docName = r.docName;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    var message = {c:collection, d:docName, v:r.v};</span>
<span class="cstat-no" title="statement not covered" >    messages.push(message);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (lastType !== r.type) {</span>
<span class="cstat-no" title="statement not covered" >      lastType = message.type = r.type;</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (qopts.docMode) {</span>
<span class="cstat-no" title="statement not covered" >      var atVersion = qopts.versions &amp;&amp; qopts.versions[collection] &amp;&amp; qopts.versions[collection][docName];</span>
      // Only give the client snapshot data if the client requested it and they
      // don't already have a copy of the document.
<span class="cstat-no" title="statement not covered" >      if (atVersion == null) {</span>
<span class="cstat-no" title="statement not covered" >        message.data = r.data;</span>
      } else <span class="cstat-no" title="statement not covered" >if (r.v &gt; atVersion) {</span>
        // We won't put any op data into the response, but we'll send some
        // normal ops to follow the query. This might not be the best idea - it
        // means that sometimes the query will say that a document matches
        // before you get the document's updated data.
<span class="cstat-no" title="statement not covered" >        self.agent.getOps(collection, docName, atVersion, -1, <span class="fstat-no" title="function not covered" >function(err, results) {</span></span>
<span class="cstat-no" title="statement not covered" >          if (err) {</span>
<span class="cstat-no" title="statement not covered" >            self._send({a:'fetch', c:collection, d:docName, error:err});</span>
<span class="cstat-no" title="statement not covered" >            return;</span>
          }
<span class="cstat-no" title="statement not covered" >          for (var i = 0; i &lt; results.length; i++) {</span>
<span class="cstat-no" title="statement not covered" >            self._sendOp(collection, docName, results[i]);</span>
          }
        });
      }
    }
  });
&nbsp;
<span class="cstat-no" title="statement not covered" >  return messages;</span>
};
&nbsp;
// Handle an incoming message from the client. This is the actual guts of session.js.
Session.prototype._handleMessage = <span class="fstat-no" title="function not covered" >function(req, callback) {</span>
  // First some checks of the incoming request. Error will be set to a value if a problem is found.
<span class="cstat-no" title="statement not covered" >  var error;</span>
<span class="cstat-no" title="statement not covered" >  if ((error = this._checkRequest(req))) {</span>
<span class="cstat-no" title="statement not covered" >    console.warn('Warning: Invalid request from ', this.agent.sessionId, req, 'Error: ', error);</span>
<span class="cstat-no" title="statement not covered" >    return callback(error);</span>
  }
&nbsp;
<span class="cstat-no" title="statement not covered" >  if (req.a === 'qsub' || req.a === 'qfetch' || req.a === 'qunsub') {</span>
    // Query based request.
&nbsp;
    // Queries have an ID to refer to the particular query in the client
<span class="cstat-no" title="statement not covered" >    var qid = req.id;</span>
&nbsp;
    // The index that will handle the query request. For mongo queries, this is
    // simply the collection that contains the data.
<span class="cstat-no" title="statement not covered" >    var index = req.c;</span>
&nbsp;
    // Options for liveDB.query.
<span class="cstat-no" title="statement not covered" >    var qopts = {};</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (req.o) {</span>
      // Do we send back document snapshots for the results? Either 'fetch' or 'sub'.
<span class="cstat-no" title="statement not covered" >      qopts.docMode = req.o.m;</span>
<span class="cstat-no" title="statement not covered" >      if (qopts.docMode != null &amp;&amp; qopts.docMode !== 'fetch' &amp;&amp; qopts.docMode !== 'sub')</span>
<span class="cstat-no" title="statement not covered" >        return callback('invalid query docmode: ' + qopts.docMode);</span>
&nbsp;
      // The client tells us what versions it already has
<span class="cstat-no" title="statement not covered" >      qopts.versions = req.o.vs;</span>
&nbsp;
      // Enables polling mode, which forces the query to be rerun on the whole
      // index, not just the edited document.
<span class="cstat-no" title="statement not covered" >      qopts.poll = req.o.p;</span>
&nbsp;
      // Set the backend for the request (useful if you have a SOLR index or something)
<span class="cstat-no" title="statement not covered" >      qopts.backend = req.o.b;</span>
    }
  } else <span class="cstat-no" title="statement not covered" >if (req.a !== 'bs') {</span>
<span class="cstat-no" title="statement not covered" >    var collection = req.c;</span>
<span class="cstat-no" title="statement not covered" >    var docName = req.d;</span>
  }
&nbsp;
<span class="cstat-no" title="statement not covered" >  var self = this;</span>
<span class="cstat-no" title="statement not covered" >  var agent = this.agent;</span>
&nbsp;
  // Now process the actual message.
<span class="cstat-no" title="statement not covered" >  switch (req.a) {</span>
    case 'fetch':
      // Fetch request.
<span class="cstat-no" title="statement not covered" >      if (req.v != null) {</span>
        // It says fetch on the tin, but if a version is specified the client
        // actually wants me to fetch some ops.
<span class="cstat-no" title="statement not covered" >        agent.getOps(collection, docName, req.v, null, <span class="fstat-no" title="function not covered" >function(err, results) {</span></span>
<span class="cstat-no" title="statement not covered" >          if (err) <span class="cstat-no" title="statement not covered" >return callback(err);</span></span>
&nbsp;
<span class="cstat-no" title="statement not covered" >          for (var i = 0; i &lt; results.length; i++) {</span>
<span class="cstat-no" title="statement not covered" >            self._sendOp(collection, docName, results[i]);</span>
          }
&nbsp;
<span class="cstat-no" title="statement not covered" >          callback(null, {});</span>
        });
      } else {
        // Fetch a snapshot.
<span class="cstat-no" title="statement not covered" >        agent.fetch(collection, docName, <span class="fstat-no" title="function not covered" >function(err, data) {</span></span>
<span class="cstat-no" title="statement not covered" >          if (err) <span class="cstat-no" title="statement not covered" >return callback(err);</span></span>
&nbsp;
<span class="cstat-no" title="statement not covered" >          callback(null, {data: data});</span>
        });
      }
<span class="cstat-no" title="statement not covered" >      break;</span>
&nbsp;
    case 'sub':
      // Subscribe to a document. If the version is specified, we'll catch the
      // client up by sending all ops since the specified version.
      //
      // If the version is not specified, the client doesn't have a snapshot
      // yet. We'll send them a snapshot at the most recent version and stream
      // operations from that version.
<span class="cstat-no" title="statement not covered" >      this._subscribe(collection, docName, req.v, <span class="fstat-no" title="function not covered" >function(err, data) {</span></span>
<span class="cstat-no" title="statement not covered" >        if (err)</span>
<span class="cstat-no" title="statement not covered" >          callback(err);</span>
        else
<span class="cstat-no" title="statement not covered" >          callback(null, {data:data});</span>
      });
<span class="cstat-no" title="statement not covered" >      break;</span>
&nbsp;
    case 'bs':
<span class="cstat-no" title="statement not covered" >      this.bulkSubscribe(req.s, <span class="fstat-no" title="function not covered" >function(err, response) {</span></span>
<span class="cstat-no" title="statement not covered" >        callback(err, err ? null : {s:response});</span>
      });
<span class="cstat-no" title="statement not covered" >      break;</span>
&nbsp;
    case 'unsub':
      // Unsubscribe from the specified document. This cancels the active
      // opstream or an inflight subscribing state
<span class="cstat-no" title="statement not covered" >      this._setSubscribed(collection, docName, false);</span>
<span class="cstat-no" title="statement not covered" >      callback(null, {});</span>
<span class="cstat-no" title="statement not covered" >      break;</span>
&nbsp;
    case 'op':
      // Submit an operation.
      //
      // Shallow clone to get just the op data parts.
<span class="cstat-no" title="statement not covered" >      var opData = {</span>
        // src can be provided if it is not the same as the current session,
        // such as a resubmission after a reconnect, but it usually isn't needed
        src: req.src || agent.sessionId,
        seq: req.seq,
        v: req.v
      };
<span class="cstat-no" title="statement not covered" >      if (req.op) <span class="cstat-no" title="statement not covered" >opData.op = req.op;</span></span>
<span class="cstat-no" title="statement not covered" >      if (req.create) <span class="cstat-no" title="statement not covered" >opData.create = req.create;</span></span>
<span class="cstat-no" title="statement not covered" >      if (req.del) <span class="cstat-no" title="statement not covered" >opData.del = req.del;</span></span>
&nbsp;
      // There's nothing to put in here yet. We might end up with some stuff
      // from the client.
<span class="cstat-no" title="statement not covered" >      var options = {};</span>
&nbsp;
      // Actually submit the op to the backend
<span class="cstat-no" title="statement not covered" >      agent.submit(collection, docName, opData, options, <span class="fstat-no" title="function not covered" >function(err, v, ops) {</span></span>
        // Occassional 'Op already submitted' errors are expected to happen
        // as part of normal operation, since inflight ops need to be resent
        // after disconnect
<span class="cstat-no" title="statement not covered" >        if (err) {</span>
<span class="cstat-no" title="statement not covered" >          console.error('Op error:', err, collection, docName, opData, options);</span>
<span class="cstat-no" title="statement not covered" >          if (err === 'Op already submitted') {</span>
<span class="cstat-no" title="statement not covered" >            self._sendOp(collection, docName, opData);</span>
          }
<span class="cstat-no" title="statement not covered" >          callback(null, {a: 'ack', error: err});</span>
<span class="cstat-no" title="statement not covered" >          return;</span>
        }
&nbsp;
        // The backend replies with any operations that the client is missing.
        // If the client is subscribed to the document, it'll get those
        // operations through the regular subscription channel. If the client
        // isn't subscribed, we'll send the ops with the response as if it was
        // subscribed so the client catches up.
<span class="cstat-no" title="statement not covered" >        if (!self._isSubscribed(collection, docName)) {</span>
<span class="cstat-no" title="statement not covered" >          for (var i = 0; i &lt; ops.length; i++) {</span>
<span class="cstat-no" title="statement not covered" >            var op = ops[i];</span>
<span class="cstat-no" title="statement not covered" >            if (!op) {</span>
<span class="cstat-no" title="statement not covered" >              console.warn('Null op ignored in agent.submit callback.', collection, docName, opData, v, ops);</span>
<span class="cstat-no" title="statement not covered" >              continue;</span>
            }
<span class="cstat-no" title="statement not covered" >            self._sendOp(collection, docName, op);</span>
          }
          // Luckily, the op is transformed &amp; etc in place.
<span class="cstat-no" title="statement not covered" >          self._sendOp(collection, docName, opData);</span>
        }
<span class="cstat-no" title="statement not covered" >        callback(null, {a: 'ack'});</span>
      });
<span class="cstat-no" title="statement not covered" >      break;</span>
&nbsp;
&nbsp;
    // ********* Queries **********
&nbsp;
    case 'qfetch':
      // Fetch the results of a query. This does not subscribe to the query or
      // anything, its just a once-off query fetch.
<span class="cstat-no" title="statement not covered" >      agent.queryFetch(index, req.q, qopts, <span class="fstat-no" title="function not covered" >function(err, results, extra) {</span></span>
<span class="cstat-no" title="statement not covered" >        if (err) <span class="cstat-no" title="statement not covered" >return callback(err);</span></span>
&nbsp;
        // If the query subscribes to documents, the callback isn't called
        // until all the documents are subscribed.
<span class="cstat-no" title="statement not covered" >        var data = self._processQueryResults(req.c, results, qopts);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        callback(null, {id:qid, data:data, extra:extra});</span>
        //self._reply(req, null, {id:qid, data:results, extra:extra});
      });
<span class="cstat-no" title="statement not covered" >      break;</span>
&nbsp;
    case 'qsub':
      // Subscribe to a query. The client is sent the query results and its
      // notified whenever there's a change.
<span class="cstat-no" title="statement not covered" >      agent.query(index, req.q, qopts, <span class="fstat-no" title="function not covered" >function(err, emitter, results, extra) {</span></span>
<span class="cstat-no" title="statement not covered" >        if (err) <span class="cstat-no" title="statement not covered" >return callback(err);</span></span>
<span class="cstat-no" title="statement not covered" >        if (self.queries[qid]) {</span>
<span class="cstat-no" title="statement not covered" >          emitter.destroy();</span>
<span class="cstat-no" title="statement not covered" >          return callback('ID in use');</span>
        }
<span class="cstat-no" title="statement not covered" >        if (self.closed) <span class="cstat-no" title="statement not covered" >return emitter.destroy();</span></span>
&nbsp;
        // `emitter` is a QueryEmitter passed through from LiveDB that emits
        // events whenever the results change. Livedb is responsible for
        // rerunning queries in the most efficient (or most expedient) manner.
<span class="cstat-no" title="statement not covered" >        self.queries[qid] = emitter;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        emitter.onExtra = <span class="fstat-no" title="function not covered" >function(extra) {</span></span>
<span class="cstat-no" title="statement not covered" >          self._send({a: 'q', id: qid, extra: extra});</span>
        };
&nbsp;
        // Note that only the docMode and not the full qopts is used, since
        // qopts has the doc versions for the original subscription, and this
        // emitter is sending an update from an ongoing subscription
<span class="cstat-no" title="statement not covered" >        var insertQueryOptions = {docMode: qopts.docMode};</span>
<span class="cstat-no" title="statement not covered" >        emitter.onDiff = <span class="fstat-no" title="function not covered" >function(diff) {</span></span>
<span class="cstat-no" title="statement not covered" >          for (var i = 0; i &lt; diff.length; i++) {</span>
<span class="cstat-no" title="statement not covered" >            var d = diff[i];</span>
<span class="cstat-no" title="statement not covered" >            if (d.type === 'insert') {</span>
<span class="cstat-no" title="statement not covered" >              d.values = self._processQueryResults(req.c, d.values, insertQueryOptions);</span>
            }
          }
&nbsp;
          // Consider stripping the collection out of the data we send here
          // if it matches the query's index.
<span class="cstat-no" title="statement not covered" >          self._send({a:'q', id:qid, diff:diff});</span>
        };
&nbsp;
<span class="cstat-no" title="statement not covered" >        emitter.onError = <span class="fstat-no" title="function not covered" >function(err) {</span></span>
          // Should we destroy the emitter here?
<span class="cstat-no" title="statement not covered" >          self._send({a:'q', id:qid, error:err});</span>
<span class="cstat-no" title="statement not covered" >          console.warn('Query ' + index + '.' + JSON.stringify(req.q) + ' emitted an error:', err);</span>
<span class="cstat-no" title="statement not covered" >          emitter.destroy();</span>
<span class="cstat-no" title="statement not covered" >          delete self.queries[qid];</span>
        };
&nbsp;
<span class="cstat-no" title="statement not covered" >        emitter.onOp = <span class="fstat-no" title="function not covered" >function(data) {</span></span>
<span class="cstat-no" title="statement not covered" >          var collection = data.collection;</span>
<span class="cstat-no" title="statement not covered" >          var docName = data.docName;</span>
          // No need to send from the query if the doc is also subscribed
<span class="cstat-no" title="statement not covered" >          if (self._isSubscribed(collection, docName)) <span class="cstat-no" title="statement not covered" >return;</span></span>
          // ShareJS filter middleware that might be doing access control or something
<span class="cstat-no" title="statement not covered" >          agent.filterOp(collection, docName, data, <span class="fstat-no" title="function not covered" >function(err, filtered) {</span></span>
<span class="cstat-no" title="statement not covered" >            if (err) <span class="cstat-no" title="statement not covered" >return emitter.onError(err);</span></span>
<span class="cstat-no" title="statement not covered" >            self._sendOp(collection, docName, filtered);</span>
          });
        };
&nbsp;
<span class="cstat-no" title="statement not covered" >        var data = self._processQueryResults(req.c, results, qopts);</span>
<span class="cstat-no" title="statement not covered" >        callback(null, {id: qid, data: data, extra: extra});</span>
      });
<span class="cstat-no" title="statement not covered" >      break;</span>
&nbsp;
    case 'qunsub':
      // Unsubscribe from a query.
<span class="cstat-no" title="statement not covered" >      var emitter = self.queries[qid];</span>
<span class="cstat-no" title="statement not covered" >      if (emitter) {</span>
<span class="cstat-no" title="statement not covered" >        emitter.destroy();</span>
<span class="cstat-no" title="statement not covered" >        delete self.queries[qid];</span>
      }
<span class="cstat-no" title="statement not covered" >      callback();</span>
<span class="cstat-no" title="statement not covered" >      break;</span>
&nbsp;
    default:
<span class="cstat-no" title="statement not covered" >      console.warn('invalid message', req);</span>
<span class="cstat-no" title="statement not covered" >      callback('invalid or unknown message');</span>
  }
};
&nbsp;
// For debugging, this returns information on how many documents &amp; queries are currently subscribed.
Session.prototype.subscribeStats = <span class="fstat-no" title="function not covered" >function() {</span>
<span class="cstat-no" title="statement not covered" >  var stats = {};</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  for (var c in this.collections) {</span>
<span class="cstat-no" title="statement not covered" >    var count = 0;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    for (var d in this.collections[c]) {</span>
<span class="cstat-no" title="statement not covered" >      if (this.collections[c][d]) <span class="cstat-no" title="statement not covered" >count++;</span></span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    stats[c] = count;</span>
  }
&nbsp;
<span class="cstat-no" title="statement not covered" >  return stats;</span>
};
&nbsp;
<span class="fstat-no" title="function not covered" >function hasKeys(object) {</span>
<span class="cstat-no" title="statement not covered" >  for (var key in object) <span class="cstat-no" title="statement not covered" >return true;</span></span>
<span class="cstat-no" title="statement not covered" >  return false;</span>
}
&nbsp;
// Destroy a linked list of streams
<span class="fstat-no" title="function not covered" >function destroyStream(opstream) {</span>
<span class="cstat-no" title="statement not covered" >  opstream.destroy();</span>
<span class="cstat-no" title="statement not covered" >  opstream.removeAllListeners('data');</span>
}
&nbsp;
&nbsp;</pre></td></tr>
</table></pre>
</div>
<div class="footer">
    <div class="meta">Generated by <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a> at Tue Apr 25 2017 03:52:12 GMT+0000 (UTC)</div>
</div>
</body>
</html>
